generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model PrivateMessage {
  id              String        @id @default(uuid())
  senderId        String
  receiverId      String
  cipherText      String        @db.LongText
  iv              String
  senderPublicKey String
  burnAfterRead   Boolean       @default(false)
  createdAt       DateTime      @default(now())
  status          MessageStatus @default(SENT)
  updatedAt       DateTime      @updatedAt

  @@index([senderId, receiverId])
  @@map("privatemessage")
}

model Group {
  id          String   @id @default(uuid())
  name        String
  createdAt   DateTime @default(now())
  description String?
  inviteCode  String   @unique @default(uuid())
  isPublic    Boolean  @default(false)

  @@map("group")
}

model GroupMember {
  id                String    @id @default(uuid())
  groupId           String
  userId            String
  encryptedGroupKey String    @db.LongText
  keyVersion        Int
  createdAt         DateTime  @default(now())
  role              GroupRole @default(MEMBER)

  @@unique([groupId, userId])
  @@map("groupmember")
}

model GroupMessage {
  id         String        @id @default(uuid())
  groupId    String
  senderId   String
  cipherText String        @db.LongText
  iv         String
  keyVersion Int
  status     MessageStatus @default(SENT)
  createdAt  DateTime      @default(now())
  sender     user          @relation("GroupSender", fields: [senderId], references: [id])

  @@map("groupmessage")
}

model MessageReceipt {
  id        String        @id @default(uuid())
  messageId String
  userId    String
  status    MessageStatus @default(READ)
  readAt    DateTime      @default(now())

  @@unique([messageId, userId])
  @@map("messagereceipt")
}

model EncryptedFile {
  id         String   @id @default(uuid())
  uploaderId String
  filePath   String
  mimeType   String
  fileSize   Int
  createdAt  DateTime @default(now())

  @@map("encryptedfile")
}

model MessageAttachment {
  id          String   @id @default(uuid())
  messageId   String
  messageType String
  mediaId     String
  mediaType   String
  mediaUrl    String
  thumbnail   String?
  metadata    String?  @db.Text
  createdAt   DateTime @default(now())

  @@index([messageId])
  @@index([mediaId])
  @@map("messageattachment")
}

model MessageReaction {
  id        String   @id @default(uuid())
  messageId String
  userId    String
  emoji     String
  createdAt DateTime @default(now())
  user      user     @relation("ReactionUser", fields: [userId], references: [id])

  @@unique([messageId, userId, emoji])
  @@map("messagereaction")
}

model VoicePlaybackPosition {
  id            String   @id @default(uuid())
  voiceMessageId String  @unique
  userId        String
  position      Float    // Position in seconds
  updatedAt     DateTime @updatedAt

  @@unique([voiceMessageId, userId])
  @@map("voiceplaybackposition")
}

model loginaudit {
  id        String   @id @default(uuid())
  userId    String?
  email     String
  ip        String
  success   Boolean
  createdAt DateTime @default(now())

  @@index([email])
  @@index([ip])
  @@map("loginaudit")
}

model refreshtoken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  isRevoked Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      user     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("refreshtoken")
}

model user {
  id              String              @id @default(uuid())
  email           String              @unique
  passwordHash    String?
  fullName        String
  phone           String?
  profilePic      String?
  provider        user_provider       @default(EMAIL)
  status          user_status         @default(ACTIVE)
  isEmailVerified Boolean             @default(false)
  role            user_role           @default(USER)
  lastSeen        DateTime?          @default(now())
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  groupMessages   GroupMessage[]      @relation("GroupSender")
  reactions       MessageReaction[]   @relation("ReactionUser")
  refreshtoken    refreshtoken[]

  @@index([email])
  @@map("user")
}

enum MessageStatus {
  SENT
  DELIVERED
  READ
  DELETED
}

enum GroupRole {
  ADMIN
  MODERATOR
  MEMBER
}

enum user_provider {
  EMAIL
  GOOGLE
}

enum user_status {
  ACTIVE
  SUSPENDED
  DELETED
}

enum user_role {
  USER
  ADMIN
}
